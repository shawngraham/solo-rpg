<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Wretched & Alone Gamepad</title>
    <!-- MOVED: All styles are now in an external file -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="fate-panel">
            <h2>Fate</h2>
            <div class="section">
                <h3>Roll 2d6</h3>
                <div class="dice-container">
                    <div class="die" id="die1">-<span class="die-label">d6</span></div>
                    <div class="die" id="die2">-<span class="die-label">d6</span></div>
                </div>
                <button onclick="rollDice()">Roll Dice</button>
                <div class="result" id="diceResult">Total: -</div>
            </div>
            <div class="section">
                <h3>Draw Card</h3>
                <button onclick="drawCard()">Draw Card</button>
                <div class="card-display" id="cardResult">No card drawn</div>
                <div class="deck-info">
                    <span id="remainingCards"></span>
                    <button onclick="reshuffleDeck()" id="reshuffleButton" style="display: none;">Reshuffle Deck</button>
                </div>
                <div class="history-header">
                    <h4>Card History</h4>
                    <button class="clear-history" onclick="clearHistory()">Clear</button>
                </div>
                <div class="card-history" id="cardHistory"></div>
            </div>
            <div class="section">
                <h3>Tower Pull</h3>
                <button onclick="towerPull()" id="pullButton">Pull Block</button>
                <div class="narrative-message" id="towerResult">The tower stands steady, waiting for the first pull...</div>
                <div class="dice-pool-info" id="dicePoolStatus"></div>
                <div class="dread-meter"><div class="dread-bar" id="dreadBar"></div></div>
                <div class="dice-pool-info" id="dreadStatus"></div>
            </div>
            <div class="section">
                <h3>Salvation Tokens (Ace of Hearts)</h3>
                <div class="salvation-controls">
                    <div class="salvation-value">
                        <button onclick="adjustSalvation(-1)">-</button>
                        <span id="salvationValue">10</span>
                        <button onclick="adjustSalvation(1)">+</button>
                    </div>
                    <div class="salvation-checkbox">
                        <input type="checkbox" id="countUp">
                        <label for="countUp">Count up?</label>
                    </div>
                </div>
                <div class="dice-container">
                    <div class="die" id="salvationDie">-<span class="die-label">d6</span></div>
                </div>
                <button onclick="rollSalvationDie()">Roll Die</button>
                <div class="result" id="salvationResult">Ready to roll...</div>
            </div>
        </div>

        <div class="journal-panel">
            <div class="instructions-panel">
                <img src="VoWAHC.png" align="right">
                <h2>Wretched & Alone Game Pad</h2>
                <h3>by Shawn Graham</h3>
                <p>
                    This site helps you play solo journaling RPGs using the 
                    <a href="https://sealedlibrary.itch.io/wretched-alone-srd" target="_blank">Wretched & Alone</a> system by Chris Bissette.
                </p>
                <div class="action-buttons">
                    <button id="newGameButton" class="action-button" onclick="newGame()">New Game</button>
                    <button id="helpButton" class="action-button" onclick="openModal('helpModal')">Help</button>
                </div>
            </div>
            <h2>Journal</h2>
            <div class="auto-save-indicator" id="saveIndicator"></div>
            <textarea id="journal" placeholder="Record your adventure here..." oninput="autoSave()"></textarea>
            <div class="save-section">
                <button class="save-button" onclick="downloadJournal()">Save to File</button>
                <button class="save-button" onclick="loadFile()">Load File</button>
            </div>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileLoad(event)">
            
            <div class="quote-box">
                <p><small><i>Games, then, are a unique social technology. They are a method for inscribing forms of agency into artifactual vessels: for recording them, preserving them, and passing them around. And we possess a special ability; we can submerge ourselves in alternate agencies designed by another. In other words, we can use games to communicate forms of agency.</i><br> C Thi Nguyen <i>Games: Agency as Art</i> 2020: 1.</small></p>
            </div>
        </div>
    </div>

    <div id="gameSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome, Survivor</h2>
            <p>Please select a game to begin, or choose to bring your own rulebook.</p>
            <div id="gameList"></div>
            <hr style="margin: 20px 0;">
            <button class="game-selection-button" style="background: #6c757d;" onclick="selectGame(null)">
                Bring Your Own Game
                <span class="author">Dismiss this and use your own ruleset.</span>
            </button>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('helpModal')">&times;</button>
            <h2>How to Play</h2>
            <p>This gamepad provides the tools needed to play a "Wretched & Alone" system game.</p>
            <ul>
                <li><strong>Dice (2d6):</strong> Many games require you to roll two six-sided dice to answer prompts.</li>
                <li><strong>Cards:</strong> Prompts are often tied to drawing a standard playing card. The suit and value determine the event. When the deck is empty, you reshuffle.</li>
                <li><strong>Tower Pull:</strong> This is the core tension mechanic, simulating a Jenga tower.
                    <ul>
                        <li>The tower begins with 100 "Stability". Each pull, you roll a number of virtual dice equal to the current stability.</li>
                        <li><strong>The risk escalates!</strong> As stability drops, the chance of losing more points per pull increases dramatically, making the endgame tense and dangerous.</li>
                        <li>When stability reaches 0, the tower collapses, and the game ends.</li>
                    </ul>
                </li>
                <li><strong>Salvation Tokens:</strong> This is a counter for games that use a token system, often tied to the Ace of Hearts.</li>
                <li><strong>Journal:</strong> This is where you write your story. Your entries are auto-saved to your browser. Use the "Save to File" button to download a permanent copy.</li>
                <li><strong>New Game:</strong> This button will completely erase your journal, card history, and tower state from the browser, allowing you to start fresh.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('modal-visible');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('modal-visible');
        }

        // --- NEW GAME AND ONBOARDING ---
        function newGame() {
            if (confirm('Are you sure you want to start a new game? This will erase all your current progress (journal, tower, etc.).')) {
                localStorage.clear();
                location.reload();
            }
        }

        function selectGame(url) {
            if (url) {
                window.open(url, '_blank');
            }
            localStorage.setItem('gameInProgress', 'true');
            closeModal('gameSelectModal');
        }

        async function fetchConfigAndShowModal() {
            if (localStorage.getItem('gameInProgress')) {
                return;
            }

            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const gameListDiv = document.getElementById('gameList');
                
                data.games.forEach(game => {
                    const button = document.createElement('button');
                    button.className = 'game-selection-button';
                    button.innerHTML = `${game.name} <span class="author">by ${game.author}</span>`;
                    button.onclick = () => selectGame(game.url);
                    gameListDiv.appendChild(button);
                });
            } catch (error) {
                console.error("Could not load config.json:", error);
            } finally {
                openModal('gameSelectModal');
            }
        }

        // --- DICE ROLLING ---
        // MODIFIED for animation
        function rollDice() {
            const die1El = document.getElementById('die1');
            const die2El = document.getElementById('die2');
            
            // Add animation class
            die1El.classList.add('rolling');
            die2El.classList.add('rolling');
            
            // Wait for the animation to finish before showing the result
            setTimeout(() => {
                const die1 = Math.floor(Math.random() * 6) + 1;
                const die2 = Math.floor(Math.random() * 6) + 1;
                
                die1El.firstChild.textContent = die1;
                die2El.firstChild.textContent = die2;
                document.getElementById('diceResult').textContent = `Total: ${die1 + die2}`;

                // Remove animation class to allow re-rolling
                die1El.classList.remove('rolling');
                die2El.classList.remove('rolling');
            }, 600); // Duration matches CSS animation
        }

        // --- CARD DRAWING ---
        let deck = [];
        let cardHistory = [];
        const maxHistoryLength = 50;

        function initializeDeck() {
            const suits = ['♠', '♣', '♥', '♦'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push(`${value}${suit}`);
                }
            }
            updateDeckInfo();
        }

        function drawCard() {
            if (deck.length === 0) {
                document.getElementById('reshuffleButton').style.display = 'block';
                document.getElementById('cardResult').textContent = 'Deck is empty! Please reshuffle.';
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * deck.length);
            const card = deck.splice(randomIndex, 1)[0];
            const timestamp = new Date().toLocaleTimeString();
            
            cardHistory.unshift({ card, timestamp, remainingCards: deck.length });
            if (cardHistory.length > maxHistoryLength) cardHistory.pop();
            
            const cardResultElement = document.getElementById('cardResult');
            cardResultElement.textContent = card;
            cardResultElement.classList.toggle('red-card', card.includes('♥') || card.includes('♦'));

            updateDeckInfo();
            updateHistoryDisplay();
            localStorage.setItem('cardHistory', JSON.stringify(cardHistory));
        }

        function reshuffleDeck() {
            initializeDeck();
            document.getElementById('reshuffleButton').style.display = 'none';
            document.getElementById('cardResult').textContent = 'Deck reshuffled';
            document.getElementById('cardResult').classList.remove('red-card');
            updateHistoryDisplay();
        }

        function updateDeckInfo() {
            document.getElementById('remainingCards').textContent = `Remaining cards: ${deck.length}/52`;
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('cardHistory');
            historyDiv.innerHTML = cardHistory.map(entry => {
                const isRed = entry.card.includes('♥') || entry.card.includes('♦');
                const cardSpan = `<span class="${isRed ? 'red-card' : ''}">${entry.card}</span>`;
                return `<div class="card-history-item">${cardSpan}<span>${entry.timestamp}</span></div>`;
            }).join('');
        }

        function clearHistory() {
            cardHistory = [];
            updateHistoryDisplay();
            localStorage.setItem('cardHistory', JSON.stringify(cardHistory));
        }

        // --- JENGA TOWER SIMULATION ---
        const safeMessages = ["The tower wobbles, but holds steady.", "The tower shifts slightly as you pull out the block.", "A gentle sway, but the tower holds firm.", "The blocks settle into their new position.", "A successful pull; the tower barely notices."];
        const dangerMessages = ["The tower is leaning quite dangerously!", "The tower sways violently as you touch it.", "The structure groans under its own weight.", "The blocks shift precariously.", "Each movement threatens to bring it all down."];
        const criticalMessages = ["A crack splinters through the tower's base!", "You feel the entire structure give way slightly as you pull.", "Dust rains down as the tower groans under immense pressure.", "The world seems to hold its breath; this could be the end.", "Every block feels like a vital organ; one wrong move..."];

        function getRandomMessage(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        let dicePool = 100;
        let dreadMeter = 0;
        const maxDread = 10;

        function rollDicePool(pool, failureThreshold) {
            let failures = 0;
            for (let i = 0; i < pool; i++) {
                if (Math.floor(Math.random() * 6) + 1 <= failureThreshold) failures++;
            }
            return failures;
        }

        function getStabilityClass(remainingDice) {
            if (remainingDice <= 20) return 'stability-critical';
            if (remainingDice <= 50) return 'stability-warning';
            return 'stability-safe';
        }

        function updateDreadDisplay() {
            const dreadBar = document.getElementById('dreadBar');
            const dreadPercent = (dreadMeter / maxDread) * 100;
            dreadBar.style.width = `${dreadPercent}%`;
            dreadBar.classList.toggle('high-dread', dreadMeter >= maxDread * 0.8);
            
            let dreadLevelText = 'Dread: None';
            if (dreadMeter > 0 && dreadMeter <= maxDread * 0.5) dreadLevelText = `Dread: Low (${dreadMeter}/${maxDread})`;
            else if (dreadMeter > maxDread * 0.5 && dreadMeter <= maxDread * 0.8) dreadLevelText = `Dread: Moderate (${dreadMeter}/${maxDread})`;
            else if (dreadMeter > maxDread * 0.8) dreadLevelText = `Dread: High (${dreadMeter}/${maxDread})`;
            document.getElementById('dreadStatus').textContent = dreadLevelText;
        }

        function towerPull() {
            if (dicePool <= 0) return showGameEnd();

            dreadMeter = Math.min(dreadMeter + (dicePool <= 30 ? 2 : 1), maxDread);
            updateDreadDisplay();

            let failureThreshold = 1, riskText = "Risk: Normal (1s remove dice)";
            if (dicePool <= 20) { failureThreshold = 3; riskText = "Risk: CRITICAL"; } 
            else if (dicePool <= 50) { failureThreshold = 2; riskText = "Risk: High"; }

            const removedDice = rollDicePool(dicePool, failureThreshold);
            dicePool -= removedDice;

            const messageElement = document.getElementById('towerResult');
            if (dicePool <= 0) return showGameEnd();
            
            let chosenMessage;
            if (dicePool <= 20 || dreadMeter >= maxDread * 0.8) { messageElement.className = 'narrative-message warning-message'; chosenMessage = getRandomMessage(criticalMessages); } 
            else if (dicePool <= 50 || dreadMeter >= maxDread * 0.5) { messageElement.className = 'narrative-message warning-message'; chosenMessage = getRandomMessage(dangerMessages); } 
            else { messageElement.className = 'narrative-message safe-message'; chosenMessage = getRandomMessage(safeMessages); }
            
            messageElement.textContent = `${chosenMessage}`;// (${removedDice} stability lost.)`;
            document.getElementById('dicePoolStatus').innerHTML = `<span class="${getStabilityClass(dicePool)}">Stability: ${dicePool} | ${riskText}</span>`;
            
            localStorage.setItem('towerState', JSON.stringify({ dicePool, dreadMeter, messageState: messageElement.textContent }));
        }

        function showGameEnd() {
            const towerResultElement = document.getElementById('towerResult');
            towerResultElement.className = 'collapse-message';
            towerResultElement.innerHTML = 'The tower groans one final time before cascading down in a thunderous crash! Game Over.';
            ['dicePoolStatus', 'dreadStatus'].forEach(id => document.getElementById(id).innerHTML = '');
            document.getElementById('dreadBar').style.width = '100%';
            document.getElementById('dreadBar').classList.add('high-dread');
            document.getElementById('pullButton').disabled = true;
            
            if (!document.getElementById('resetTowerButton')) {
                const resetButton = document.createElement('button');
                resetButton.onclick = resetTower;
                resetButton.textContent = 'Build New Tower';
                resetButton.id = 'resetTowerButton';
                resetButton.style.marginTop = '20px';
                towerResultElement.appendChild(resetButton);
            }
        }

        function resetTower() {
            dicePool = 100;
            dreadMeter = 0;
            const towerResultElement = document.getElementById('towerResult');
            towerResultElement.className = 'narrative-message safe-message';
            towerResultElement.textContent = 'A fresh tower stands before you, solid and stable.';
            document.getElementById('dicePoolStatus').innerHTML = `<span class="stability-safe">Stability: ${dicePool} | Risk: Normal</span>`;
            document.getElementById('pullButton').disabled = false;
            document.getElementById('resetTowerButton')?.remove();
            updateDreadDisplay();
            localStorage.setItem('towerState', JSON.stringify({ dicePool, dreadMeter, messageState: towerResultElement.textContent }));
        }

        // --- JOURNAL ---
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            document.getElementById('saveIndicator').textContent = 'Saving...';
            saveTimeout = setTimeout(() => {
                localStorage.setItem('journalContent', document.getElementById('journal').value);
                document.getElementById('saveIndicator').textContent = `Last auto-saved at ${new Date().toLocaleTimeString()}`;
            }, 1000);
        }

        function downloadJournal() {
            const text = document.getElementById('journal').value;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rpg-journal-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function loadFile() { document.getElementById('fileInput').click(); }
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('journal').value = e.target.result;
                    autoSave();
                };
                reader.readAsText(file);
            }
        }

        // --- SALVATION TOKENS ---
        let salvationValue = 10;
        function adjustSalvation(amount) {
            salvationValue += amount;
            document.getElementById('salvationValue').textContent = salvationValue;
            localStorage.setItem('salvationValue', salvationValue);
        }

        // MODIFIED for animation
        function rollSalvationDie() {
            const dieEl = document.getElementById('salvationDie');
            dieEl.classList.add('rolling');

            setTimeout(() => {
                const dieResult = Math.floor(Math.random() * 6) + 1;
                dieEl.firstChild.textContent = dieResult;
                const resultElement = document.getElementById('salvationResult');
                if (dieResult === 6) {
                    const amount = document.getElementById('countUp').checked ? 1 : -1;
                    adjustSalvation(amount);
                    resultElement.textContent = `Rolled a 6! Salvation tokens ${amount > 0 ? 'increase' : 'decrease'} by 1.`;
                } else {
                    resultElement.textContent = `Rolled a ${dieResult}. Your tokens remain unchanged.`;
                }
                dieEl.classList.remove('rolling');
            }, 600);
        }

        // --- WINDOW ONLOAD (INITIALIZATION) ---
        window.onload = function() {
            fetchConfigAndShowModal();

            const savedTowerState = JSON.parse(localStorage.getItem('towerState'));
            if (savedTowerState) {
                dicePool = savedTowerState.dicePool;
                dreadMeter = savedTowerState.dreadMeter ?? 0;
                if (dicePool <= 0) {
                    showGameEnd();
                } else {
                    const messageElement = document.getElementById('towerResult');
                    messageElement.textContent = savedTowerState.messageState || 'The tower stands steady...';
                    messageElement.className = `narrative-message ${dicePool > 50 ? 'safe-message' : 'warning-message'}`;
                    let riskText = "Risk: Normal";
                    if (dicePool <= 20) riskText = "Risk: CRITICAL";
                    else if (dicePool <= 50) riskText = "Risk: High";
                    document.getElementById('dicePoolStatus').innerHTML = `<span class="${getStabilityClass(dicePool)}">Stability: ${dicePool} | ${riskText}</span>`;
                }
                updateDreadDisplay();
            } else {
                resetTower();
            }
            
            initializeDeck();

            document.getElementById('journal').value = localStorage.getItem('journalContent') || '';
            cardHistory = JSON.parse(localStorage.getItem('cardHistory')) || [];
            updateHistoryDisplay();
            
            salvationValue = parseInt(localStorage.getItem('salvationValue') ?? 10);
            document.getElementById('salvationValue').textContent = salvationValue;
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Solo RPG Gamepad for Wretched & Alone Style Games</title>    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="fate-panel">
            <h2>Fate</h2>
            <div class="section">
                <h3>Roll 2d6</h3>
                <div class="dice-container">
                    <div class="die" id="die1">-<span class="die-label">d6</span></div>
                    <div class="die" id="die2">-<span class="die-label">d6</span></div>
                </div>
                <button onclick="rollDice()">Roll Dice</button>
                <div class="result" id="diceResult">Total: -</div>
            </div>
            <div class="section">
                <h3>Draw Card</h3>
                <button onclick="drawCard()">Draw Card</button>
                <div class="card-display" id="cardResult">No card drawn</div>
                <div class="deck-info">
                    <span id="remainingCards"></span>
                    <button onclick="reshuffleDeck()" id="reshuffleButton" style="display: none;">Reshuffle Deck</button>
                </div>
                <div class="history-header">
                    <h4>Card History</h4>
                    <button class="clear-history" onclick="clearHistory()">Clear</button>
                </div>
                <div class="card-history" id="cardHistory"></div>
            </div>
            <div class="section">
                <h3>Mental State</h3>
                <button onclick="towerPull()" id="pullButton">Pull Block</button>
                <div class="narrative-message" id="towerResult">Your mental state, a precarious tower of blocks...</div>
                <div class="dice-pool-info" id="dicePoolStatus"></div>
                <div class="dread-meter"><div class="dread-bar" id="dreadBar"></div></div>
                <div class="dice-pool-info" id="dreadStatus"></div>
            </div>
            <div class="section">
                <h3>Salvation Tokens (Ace of Hearts)</h3>
                <div class="salvation-controls">
                    <div class="salvation-value">
                        <button onclick="adjustSalvation(-1)">-</button>
                        <span id="salvationValue">10</span>
                        <button onclick="adjustSalvation(1)">+</button>
                    </div>
                    <div class="salvation-checkbox">
                        <input type="checkbox" id="countUp">
                        <label for="countUp">Count up?</label>
                    </div>
                </div>
                <div class="dice-container">
                    <div class="die" id="salvationDie">-<span class="die-label">d6</span></div>
                </div>
                <button onclick="rollSalvationDie()">Roll Die</button>
                <div class="result" id="salvationResult">Ready to roll...</div>
            </div>
        </div>

        <div class="journal-panel">
            <div class="instructions-panel">
                <img src="VoWAHC.png" align="right">
                <h2>Wretched & Alone Game Pad</h2>
                <h3>by Shawn Graham</h3>
                <p>This site helps you play solo journaling RPGs using the 
                    <a href="https://sealedlibrary.itch.io/wretched-alone-srd" target="_blank">Wretched & Alone</a> system by Chris Bissette.
                </p>
                <div class="action-buttons">
                    <button id="newGameButton" class="action-button" onclick="newGame()">New Game</button>
                    <button id="helpButton" class="action-button" onclick="openModal('helpModal')">Help</button>
                </div>
            </div>
            <h2>Journal</h2>
            <div class="auto-save-indicator" id="saveIndicator"></div>
            <textarea id="journal" placeholder="Record your adventure here..." oninput="autoSave()"></textarea>
            <div class="save-section">
                <button class="save-button" onclick="downloadJournal()">Save to File</button>
                <button class="save-button" onclick="loadFile()">Load File</button>
            </div>
            <input type="file" id="fileInput" style="display: none;" onchange="handleFileLoad(event)">
            
            <div class="quote-box">
                <p><small><i>Games, then, are a unique social technology. They are a method for inscribing forms of agency into artifactual vessels: for recording them, preserving them, and passing them around. And we possess a special ability; we can submerge ourselves in alternate agencies designed by another. In other words, we can use games to communicate forms of agency.</i><br> C Thi Nguyen <i>Games: Agency as Art</i> 2020: 1.</small></p>
            </div>
        </div>
    </div>

    <div id="gameSelectModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Welcome, Survivor</h2>
            <p>Please select a game to begin, or choose to bring your own rulebook.</p>
            <div id="gameList"></div>
            <hr style="margin: 20px 0;">
            <button class="game-selection-button" style="background: #6c757d;" onclick="selectGame(null)">
                Bring Your Own Game
                <span class="author">Dismiss this and use your own ruleset.</span>
            </button>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('helpModal')">&times;</button>
            <h2>How to Play</h2>
            <p>This gamepad provides the tools needed to play a "Wretched & Alone" system game.</p>
            <ul>
                <li><strong>Dice (2d6):</strong> Many games require you to roll two six-sided dice to answer prompts.</li>
                <li><strong>Cards:</strong> Prompts are often tied to drawing a standard playing card. The suit and value determine the event. When the deck is empty, you reshuffle.</li>
                <li><strong>Mental State:</strong> This is the core tension mechanic, simulating a Jenga tower whose blocks are slowly pulled away.
                    <ul>
                        <li>The tower begins with 100 "Stability". Each pull, you roll a number of virtual dice equal to the current stability.</li>
                        <li><strong>The risk escalates!</strong> As stability drops, the chance of losing more points per pull increases dramatically, making the endgame tense and dangerous.</li>
                        <li>When stability reaches 0, the tower collapses, and the game ends.</li>
                    </ul>
                </li>
                <li><strong>Salvation Tokens:</strong> This is a counter for games that use a token system, often tied to the Ace of Hearts.</li>
                <li><strong>Journal:</strong> This is where you write your story. Your entries are auto-saved to your browser. Use the "Save to File" button to download a permanent copy.</li>
                <li><strong>New Game:</strong> This button will completely erase your journal, card history, and tower state from the browser, allowing you to start fresh.</li>
            </ul>
        </div>
    </div>

    <script>
        // --- MODAL CONTROLS ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('modal-visible');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('modal-visible');
        }

        // --- NEW GAME AND ONBOARDING ---
        function newGame() {
            if (confirm('Are you sure you want to start a new game? This will erase all your current progress (journal, tower, etc.).')) {
                localStorage.clear();
                location.reload();
            }
        }

        function selectGame(url) {
            if (url) {
                window.open(url, '_blank');
            }
            localStorage.setItem('gameInProgress', 'true');
            closeModal('gameSelectModal');
        }

        async function fetchConfigAndShowModal() {
            if (localStorage.getItem('gameInProgress')) {
                return;
            }

            try {
                const response = await fetch('config.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const gameListDiv = document.getElementById('gameList');
                
                data.games.forEach(game => {
                    const button = document.createElement('button');
                    button.className = 'game-selection-button';
                    button.innerHTML = `${game.name} <span class="author">by ${game.author}</span>`;
                    button.onclick = () => selectGame(game.url);
                    gameListDiv.appendChild(button);
                });
            } catch (error) {
                console.error("Could not load config.json:", error);
            } finally {
                openModal('gameSelectModal');
            }
        }

        // --- DICE ROLLING ---
        // MODIFIED for animation
        function rollDice() {
            const die1El = document.getElementById('die1');
            const die2El = document.getElementById('die2');
            
            // Add animation class
            die1El.classList.add('rolling');
            die2El.classList.add('rolling');
            
            // Wait for the animation to finish before showing the result
            setTimeout(() => {
                const die1 = Math.floor(Math.random() * 6) + 1;
                const die2 = Math.floor(Math.random() * 6) + 1;
                
                die1El.firstChild.textContent = die1;
                die2El.firstChild.textContent = die2;
                document.getElementById('diceResult').textContent = `Total: ${die1 + die2}`;

                // Remove animation class to allow re-rolling
                die1El.classList.remove('rolling');
                die2El.classList.remove('rolling');
            }, 600); // Duration matches CSS animation
        }

        // --- CARD DRAWING ---
        let deck = [];
        let cardHistory = [];
        const maxHistoryLength = 50;

        function initializeDeck() {
            const suits = ['♠', '♣', '♥', '♦'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push(`${value}${suit}`);
                }
            }
            updateDeckInfo();
        }

        function drawCard() {
            if (deck.length === 0) {
                document.getElementById('reshuffleButton').style.display = 'block';
                document.getElementById('cardResult').textContent = 'Deck is empty! Please reshuffle.';
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * deck.length);
            const card = deck.splice(randomIndex, 1)[0];
            const timestamp = new Date().toLocaleTimeString();
            
            cardHistory.unshift({ card, timestamp, remainingCards: deck.length });
            if (cardHistory.length > maxHistoryLength) cardHistory.pop();
            
            const cardResultElement = document.getElementById('cardResult');
            cardResultElement.textContent = card;
            cardResultElement.classList.toggle('red-card', card.includes('♥') || card.includes('♦'));

            updateDeckInfo();
            updateHistoryDisplay();
            localStorage.setItem('cardHistory', JSON.stringify(cardHistory));
        }

        function reshuffleDeck() {
            initializeDeck();
            document.getElementById('reshuffleButton').style.display = 'none';
            document.getElementById('cardResult').textContent = 'Deck reshuffled';
            document.getElementById('cardResult').classList.remove('red-card');
            updateHistoryDisplay();
        }

        function updateDeckInfo() {
            document.getElementById('remainingCards').textContent = `Remaining cards: ${deck.length}/52`;
        }

        function updateHistoryDisplay() {
            const historyDiv = document.getElementById('cardHistory');
            historyDiv.innerHTML = cardHistory.map(entry => {
                const isRed = entry.card.includes('♥') || entry.card.includes('♦');
                const cardSpan = `<span class="${isRed ? 'red-card' : ''}">${entry.card}</span>`;
                return `<div class="card-history-item">${cardSpan}<span>${entry.timestamp}</span></div>`;
            }).join('');
        }

        function clearHistory() {
            cardHistory = [];
            updateHistoryDisplay();
            localStorage.setItem('cardHistory', JSON.stringify(cardHistory));
        }

        // --- JENGA TOWER SIMULATION ---
        const safeMessages = [
    // Represents moments of finding focus or pushing back the despair.
    "You take a steadying breath. For now, you are in control.",
    "The panic recedes, leaving a fragile stillness in your mind.",
    "You focus on a single, concrete detail, anchoring yourself to reality.",
    "A flicker of the person you once were shines through the cracks.",
    "The voice in the back of your head falls silent. A brief, welcome respite.",
    "You push the intrusive thought away with surprising force.",
    "For a moment, the crushing weight of despair lifts, and you can breathe.",
    "Clarity cuts through the fog of fear, sharp and clean.",
    "You manage a grim smile. You're not broken yet.",
    "The memory is painful, but you face it and it loses its power.",
    "Your hands stop shaking. A small victory, but a vital one.",
    "You recite the names of the people you've lost, turning grief into a shield.",
    "The wave of nausea passes. You find your footing in your own mind.",
    "You remember why you started this. The reason is enough for one more step.",
    "A moment of defiance. You will not surrender this easily.",
    "The grim work ahead focuses your mind, pushing the fear to the periphery.",
    "You find a reserve of strength you didn't know you had.",
    "The rhythmic beat of your own heart is a steady drum against the chaos.",
    "You push down the scream that was building in your throat. Silence returns.",
    "The paranoia subsides. The shadows are just shadows."
];

        const dangerMessages = [
    // Represents the fraying of sanity, rising panic, and losing the fight.
    "A deep tremor of dread runs through you, shaking your resolve to its core.",
    "The edges of your vision swim. Is any of this real?",
    "A memory you can't place flashes behind your eyes, violent and terrifying.",
    "Your own thoughts feel alien, twisting into shapes of fear and doubt.",
    "The voice is back, whispering truths you don't want to hear.",
    "That was a mistake. A piece of your composure cracks and falls away.",
    "A cold sweat breaks out on your brow. The fear is a physical presence.",
    "You find yourself staring at nothing, lost for a moment you can't account for.",
    "The effort of holding yourself together is becoming exhausting.",
    "A wave of hopelessness washes over you, cold and suffocating.",
    "Your hands begin to tremble uncontrollably. You hide them from your own sight.",
    "The faces of the dead flicker in your peripheral vision.",
    "You catch your own reflection and, for a terrifying second, don't recognize yourself.",
    "The silence is no longer comforting; it's filled with unspoken threats.",
    "A sharp, stabbing pain lances through your skull, born of pure stress.",
    "Paranoia sinks its claws in deep. Every shadow moves, every sound is a threat.",
    "You feel a hysterical laugh bubbling up and have to choke it down.",
    "The mask of sanity you wear is slipping, and you can feel it.",
    "Your memories feel like a story you read about someone else.",
    "You are losing the thread of your own thoughts, a labyrinth with no escape."
];

        const criticalMessages = [
    // Represents the final, irreversible snap of the character's mind.
    "Something vital inside you breaks. The person you were is gone.",
    "The last thread of your sanity snaps with a deafening, silent sound.",
    "This is it. The point of no return. You welcome the abyss.",
    "Your mind fractures, reality shattering into a million meaningless pieces.",
    "The scream finally comes, raw and endless, tearing its way out of you.",
    "The world dissolves into a meaningless, terrifying swirl of color and noise.",
    "You let go. The fall into madness is blessedly quiet.",
    "The whispers are screaming now, and you are screaming with them.",
    "Your most cherished memory corrupts and turns to ash. Nothing is left.",
    "The person looking through your eyes is no longer you.",
    "A final, violent shudder, and then... nothing. The lights are out.",
    "You finally understand the terrible, beautiful truth. It drives you mad.",
    "You close your eyes, and when you open them, the world you knew is gone forever.",
    "The struggle is over. You surrender to the encroaching darkness.",
    "All the faces, all the memories, all the pain—it collapses inward into a single point of blackness.",
    "The last bastion of your mind crumbles to dust.",
    "There is no 'you' anymore. Only the fear.",
    "The cacophony in your head stops. The absolute silence is the true end.",
    "You laugh, a broken, empty sound that doesn't belong to you.",
    "And in the end, you see the monster. And it has your face."
];
        function getRandomMessage(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        let dicePool = 100;
        let dreadMeter = 0;
        const maxDread = 10;

        function rollDicePool(pool, failureThreshold) {
            let failures = 0;
            for (let i = 0; i < pool; i++) {
                if (Math.floor(Math.random() * 6) + 1 <= failureThreshold) failures++;
            }
            return failures;
        }

        function getStabilityClass(remainingDice) {
            if (remainingDice <= 20) return 'stability-critical';
            if (remainingDice <= 50) return 'stability-warning';
            return 'stability-safe';
        }

        function updateDreadDisplay() {
            const dreadBar = document.getElementById('dreadBar');
            const dreadPercent = (dreadMeter / maxDread) * 100;
            dreadBar.style.width = `${dreadPercent}%`;
            dreadBar.classList.toggle('high-dread', dreadMeter >= maxDread * 0.8);
            
            let dreadLevelText = 'Dread: None';
            if (dreadMeter > 0 && dreadMeter <= maxDread * 0.5) dreadLevelText = `Dread: Low (${dreadMeter}/${maxDread})`;
            else if (dreadMeter > maxDread * 0.5 && dreadMeter <= maxDread * 0.8) dreadLevelText = `Dread: Moderate (${dreadMeter}/${maxDread})`;
            else if (dreadMeter > maxDread * 0.8) dreadLevelText = `Dread: High (${dreadMeter}/${maxDread})`;
            document.getElementById('dreadStatus').textContent = dreadLevelText;
        }

        function towerPull() {
            if (dicePool <= 0) return showGameEnd();

            dreadMeter = Math.min(dreadMeter + (dicePool <= 30 ? 2 : 1), maxDread);
            updateDreadDisplay();

            let failureThreshold = 1, riskText = "Risk: Normal (1s remove dice)";
            if (dicePool <= 20) { failureThreshold = 3; riskText = "Risk: CRITICAL"; } 
            else if (dicePool <= 50) { failureThreshold = 2; riskText = "Risk: High"; }

            const removedDice = rollDicePool(dicePool, failureThreshold);
            dicePool -= removedDice;

            const messageElement = document.getElementById('towerResult');
            if (dicePool <= 0) return showGameEnd();
            
            let chosenMessage;
            if (dicePool <= 20 || dreadMeter >= maxDread * 0.8) { messageElement.className = 'narrative-message warning-message'; chosenMessage = getRandomMessage(criticalMessages); } 
            else if (dicePool <= 50 || dreadMeter >= maxDread * 0.5) { messageElement.className = 'narrative-message warning-message'; chosenMessage = getRandomMessage(dangerMessages); } 
            else { messageElement.className = 'narrative-message safe-message'; chosenMessage = getRandomMessage(safeMessages); }
            
            messageElement.textContent = `${chosenMessage}`;// (${removedDice} stability lost.)`;
            document.getElementById('dicePoolStatus').innerHTML = `<span class="${getStabilityClass(dicePool)}">Stability: ${dicePool} | ${riskText}</span>`;
            
            localStorage.setItem('towerState', JSON.stringify({ dicePool, dreadMeter, messageState: messageElement.textContent }));
        }

        function showGameEnd() {
            const towerResultElement = document.getElementById('towerResult');
            towerResultElement.className = 'collapse-message';
            towerResultElement.innerHTML = 'The tower groans one final time before cascading down in a thunderous crash! Game Over.';
            ['dicePoolStatus', 'dreadStatus'].forEach(id => document.getElementById(id).innerHTML = '');
            document.getElementById('dreadBar').style.width = '100%';
            document.getElementById('dreadBar').classList.add('high-dread');
            document.getElementById('pullButton').disabled = true;
            
            if (!document.getElementById('resetTowerButton')) {
                const resetButton = document.createElement('button');
                resetButton.onclick = resetTower;
                resetButton.textContent = 'Build New Tower';
                resetButton.id = 'resetTowerButton';
                resetButton.style.marginTop = '20px';
                towerResultElement.appendChild(resetButton);
            }
        }

        function resetTower() {
            dicePool = 100;
            dreadMeter = 0;
            const towerResultElement = document.getElementById('towerResult');
            towerResultElement.className = 'narrative-message safe-message';
            towerResultElement.textContent = 'Your mind, solid and stable. For now.';
            document.getElementById('dicePoolStatus').innerHTML = `<span class="stability-safe">Stability: ${dicePool} | Risk: Normal</span>`;
            document.getElementById('pullButton').disabled = false;
            document.getElementById('resetTowerButton')?.remove();
            updateDreadDisplay();
            localStorage.setItem('towerState', JSON.stringify({ dicePool, dreadMeter, messageState: towerResultElement.textContent }));
        }

        // --- JOURNAL ---
        let saveTimeout;
        function autoSave() {
            clearTimeout(saveTimeout);
            document.getElementById('saveIndicator').textContent = 'Saving...';
            saveTimeout = setTimeout(() => {
                localStorage.setItem('journalContent', document.getElementById('journal').value);
                document.getElementById('saveIndicator').textContent = `Last auto-saved at ${new Date().toLocaleTimeString()}`;
            }, 1000);
        }

        function downloadJournal() {
            const text = document.getElementById('journal').value;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `rpg-journal-${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function loadFile() { document.getElementById('fileInput').click(); }
        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('journal').value = e.target.result;
                    autoSave();
                };
                reader.readAsText(file);
            }
        }

        // --- SALVATION TOKENS ---
        let salvationValue = 10;
        function adjustSalvation(amount) {
            salvationValue += amount;
            document.getElementById('salvationValue').textContent = salvationValue;
            localStorage.setItem('salvationValue', salvationValue);
        }

        // MODIFIED for animation
        function rollSalvationDie() {
            const dieEl = document.getElementById('salvationDie');
            dieEl.classList.add('rolling');

            setTimeout(() => {
                const dieResult = Math.floor(Math.random() * 6) + 1;
                dieEl.firstChild.textContent = dieResult;
                const resultElement = document.getElementById('salvationResult');
                if (dieResult === 6) {
                    const amount = document.getElementById('countUp').checked ? 1 : -1;
                    adjustSalvation(amount);
                    resultElement.textContent = `Rolled a 6! Salvation tokens ${amount > 0 ? 'increase' : 'decrease'} by 1.`;
                } else {
                    resultElement.textContent = `Rolled a ${dieResult}. Your tokens remain unchanged.`;
                }
                dieEl.classList.remove('rolling');
            }, 600);
        }

        // --- WINDOW ONLOAD (INITIALIZATION) ---
        window.onload = function() {
            fetchConfigAndShowModal();

            const savedTowerState = JSON.parse(localStorage.getItem('towerState'));
            if (savedTowerState) {
                dicePool = savedTowerState.dicePool;
                dreadMeter = savedTowerState.dreadMeter ?? 0;
                if (dicePool <= 0) {
                    showGameEnd();
                } else {
                    const messageElement = document.getElementById('towerResult');
                    messageElement.textContent = savedTowerState.messageState || 'The tower stands steady...';
                    messageElement.className = `narrative-message ${dicePool > 50 ? 'safe-message' : 'warning-message'}`;
                    let riskText = "Risk: Normal";
                    if (dicePool <= 20) riskText = "Risk: CRITICAL";
                    else if (dicePool <= 50) riskText = "Risk: High";
                    document.getElementById('dicePoolStatus').innerHTML = `<span class="${getStabilityClass(dicePool)}">Stability: ${dicePool} | ${riskText}</span>`;
                }
                updateDreadDisplay();
            } else {
                resetTower();
            }
            
            initializeDeck();

            document.getElementById('journal').value = localStorage.getItem('journalContent') || '';
            cardHistory = JSON.parse(localStorage.getItem('cardHistory')) || [];
            updateHistoryDisplay();
            
            salvationValue = parseInt(localStorage.getItem('salvationValue') ?? 10);
            document.getElementById('salvationValue').textContent = salvationValue;
        };
    </script>
</body>
</html>
